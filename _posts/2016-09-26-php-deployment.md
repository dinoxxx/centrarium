---
layout: post
title:  "高德地图PHP应用发布的优化之路"
date:   2016-09-26
author: 刘宇
categories: PHP
tags:	php
---

高德地图的PHP应用发布方式，经历了手工发布、自动化发布、原子发布这三个越来越完善的阶段。相信每个公司都会经历这个过程，但不是每个PHP程序员都能经历这个过程。本文详细记录了高德地图在发展过程中，对于PHP应用发布方案的优化之路。随着Docker的崛起，未来实现容器化发布的探索工作已经开始。<!-- more -->
 
## 手工发布
我是2015年上半年来到高德的，公司内部的应用以C++和JAVA为主，由于业务需要，刚刚开始做一些PHP的在线服务，从开发、提测，一直到发布，各个环节基本上还处于手工阶段，这在项目启动伊始不可避免，毕竟从0到1是最难的。
手工发布流程如下
* 发布前，RD将本次新增或修改的文件打包，上传到一个线上服务器的约定目录，然后填写上线单，详细列出OP操作的步骤，主要是备份、解压、复制、配置等，而且还需要列出详细的回滚步骤。
* 发布时，OP先将应用部署包同步到线上全部WEB服务器，然后根据上线单的内容，写出发布脚本和回滚脚本，先在其中一台WEB服务器操作，QA冒烟验证通过后再批量执行，如果冒烟验证发现问题则执行回滚脚本。
* 发布后，RD手工将分支代码合并主干
 
不用我多说，各位都能看出很明显的问题
1. 手工操作多，效率低，失误多
2. 增量发布，有可能漏掉文件
 
这种比较原始的发布流程，每次发布都和打仗一样，全神贯注，就怕出问题。就是在这样的情况下，我们还是完成了N个PHP应用的上线。
 
## 自动化发布
借着阿里巴巴的集团资源，高德也开始接入自动化发布系统。对于高德来说，这是一次大的升级，我特意抽出一段时间，将线上的N个PHP服务接入到这个自动化发布系统中。
自动化发布流程如下
* 将SVN分支代码打包并同步到WEB服务器
* 备份、解压、复制、配置，这一系列步骤的脚本可以自由发挥
* 将SVN分支代码合并主干
 
看似和前面手工发布的步骤差不多，但是有两点关键的不同
1. 全部自动化
2. 全量发布

自动化发布大大解放了RD和OP的生产力。而且，为了降低中间环节对流量造成的影响，我们先对一个临时目录做解压和配置的操作，最后一次性复制到正式目录。
 
## 原子发布
对比手工发布，自动化发布是一个大的飞跃，但是仍不完美，在中间环节对于流量仍然是有损的。比如说A文件依赖B文件，但是A文件先于B文件完成发布，有可能导致500错误，opcache的更新机制又增加了这个概率。所以我开始调研原子发布的方案，最终选择了软链接的发布方式。
* nginx重定向到一个软链接
* 发布时，基于一个新的目录，完成解压、复制、配置等操作
* 将软链接切换到这个新的目录
 
这是一个原子发布的方案，但是由于PHP的**opcode cache**和**realpath cache**，仍然会导致非原子的发布过程
* **opcode cache**
PHP的运行过程大致分为，第一步**解析**成有意义的语言片段，第二步**编译**成opcode，第三步**执行**opcode输出结果。为了提高PHP的性能，可以将第二步的opcode缓存起来，按照php.ini中的opcache配置来更新。关键的一点，opcache的缓存键是文件的realpath。
* **realpath cache**
当我们访问一个PHP文件时，会通过**stat()**系统调用解析它的路径、链接和文件信息，最后会将realpath缓存起来，方便下次访问。在PHP的默认配置下，这个缓存每隔120秒更新一次。

如果采用软链接的发布方式，由于上述2种缓存的更新不及时，还是会导致非原子的发布过程。为了解决这个问题，在Nginx的配置中，需要按照如下方式修改。
```
fastcgi_param  SCRIPT_FILENAME	$realpath_root$fastcgi_script_name;
fastcgi_param  DOCUMENT_ROOT	$realpath_root;
```
按照以上方式配置之后，Nginx传递给PHP的已经是将软链接转换成realpath之后的值，对于PHP来说，每次发布后都会按照新的realpath来更新缓存。
 
切换软链接的**ln -sfn**命令可以真正做到原子操作吗？有点不放心，还是用**strace**来监控一下看看。
```
$mkdir a b && ln -sfn a target
$strace ln -sfn b target

symlink("b", "target")                  = -1 EEXIST (File exists)
unlink("target")                        = 0
symlink("b", "target")                  = 0 
```
 果然，直接执行**ln -sfn**命令来做软链接的切换不能保证原子操作，必须经过解除链接后才能建立链接。
```
$ln -sfn b target-tmp
$strace mv target-tmp target

rename("target-tmp", "target/target-tmp") = 0
```
先建立一个临时软链接，然后执行**mv**命令，只有重命名一个步骤，真正实现了原子操作。这也是我们优化后的最终发布脚本。
 
## 容器化发布
随着Docker的崛起，未来实现容器化发布的探索工作已经开始，但这是另外一篇文章的内容了，敬请期待。
